<!-- app/views/exercise_sets/edit.html.erb -->
<div class="w-full min-h-screen bg-[#030a08] flex flex-col items-center p-0 overflow-x-hidden">

  <!-- Top Navigation -->
  <div class="top-navigation w-full max-w-[428px] h-[70px] bg-[#a52502] rounded-bl-[30px] rounded-br-[30px] relative mb-2" data-controller="navigation" data-navigation-exercise-set-id-value="<%= @exercise_set.id %>">
    <div class="absolute inset-0 bg-[#ff8137] opacity-20 rounded-bl-[30px] rounded-br-[30px]"></div>
    <div class="absolute inset-0 flex items-center justify-between px-4">
      <%#= link_to 'javascript:history.back()', class: "w-8 h-8 bg-[#0e0e0e]/10 rounded-full border backdrop-blur-sm flex items-center justify-center" do %>
        <%# <i class="fa fa-arrow-left text-white text-sm"></i> %>
      <%# end %>
      <div class="flex-1 text-center">
        <div class="text-white text-base font-semibold">Série completa</div>
      </div>
    </div>
  </div>

  <!-- Exercise Details -->
  <div class="w-full max-w-[428px] bg-[#151c1c] rounded-[30px] p-4 mb-4">
    <div class="text-white text-base font-semibold mb-2"><%= @exercise_set.exercise.name %></div>

  <!-- Gráfico Container -->
  <div class="mb-4">
    <div class="w-full md:w-96 h-52 relative"
        data-controller="chart"
        data-chart-data-value="<%= @arduino_data.map { |datum| datum.value } %>"
        data-chart-labels-value="<%= @arduino_data.map { |datum| datum.recorded_at.strftime('%b %d') } %>">
      <%= turbo_frame_tag 'arduino_chart' do %>
        <canvas id="chart-1" class="w-full h-full"></canvas>
      <% end %>
    </div>
  </div>

  <!-- Details Section -->
  <div data-controller="reps-series" data-reps-series-exercise-set-id-value="<%= @exercise_set.id %>">
    <% if @exercise_set.reps_per_series.present? %>
      <% last_series_number = @exercise_set.reps_per_series.keys.map(&:to_i).max %>
      <% last_series_details = @exercise_set.reps_per_series[last_series_number.to_s] %>
      <div class="flex justify-between my-3 text-white text-sm">
        <div class="flex flex-col items-center">
          <div data-reps-series-target="reps" class="text-base font-semibold">
            <%= last_series_details["reps"] %>
          </div>
          <div class="text-[#9c9c9c] text-xs">Repetições</div>
        </div>
        <div class="flex flex-col items-center">
          <div data-reps-series-target="sets" class="text-base font-semibold">
            <%= last_series_number %>
          </div>
          <div class="text-[#9c9c9c] text-xs">Série</div>
        </div>
        <div class="flex flex-col items-center">
          <div class="text-base font-semibold" id="fixed-weight"><%= @exercise_set.weight %>kg</div>
          <div class="text-[#9c9c9c] text-xs">Carga</div>
        </div>
      </div>
    <% else %>
      <!-- Valores padrão quando não há dados -->
      <div class="flex justify-between my-3 text-white text-sm">
        <div class="flex flex-col items-center">
          <div class="text-base font-semibold">0</div>
          <div class="text-[#9c9c9c] text-xs">Repetições</div>
        </div>
        <div class="flex flex-col items-center">
          <div class="text-base font-semibold">0</div>
          <div class="text-[#9c9c9c] text-xs">Série</div>
        </div>
        <div class="flex flex-col items-center">
          <div class="text-base font-semibold">0kg</div>
          <div class="text-[#9c9c9c] text-xs">Carga</div>
        </div>
      </div>
    <% end %>
  </div>

    <div class="flex justify-between my-3 text-white text-sm">
      <div
          data-exercise-set-id="<%= @exercise_set.id %>"
          data-series-completed="<%= @exercise_set.sets > 0 %>"
          class="flex flex-col items-center">
        <div data-rest-time-target="value" class="text-xl font-semibold text-[#ff8900]"><%= @exercise_set.rest_time %>s</div>
        <div class="text-[#d9d9d9] text-xs">Tempo de repouso</div>
      </div>
      <div class="flex flex-col items-center">
        <div class="text-xl font-semibold text-white"><%= @exercise_set.energy_consumed %> CAL</div>
        <div class="text-[#d9d9d9] text-xs">Calorias Totais</div>
      </div>
    </div>
  </div>



  <!-- Série Details -->
  <div class="w-full max-w-[428px] bg-[#151c1c] rounded-[30px] p-4 mb-2" data-controller="dropdown">
    <h2 class="text-white text-lg font-semibold mb-4">Séries</h2>
    <%= form_with(model: @exercise_set, url: exercise_set_path(@exercise_set), method: :patch, local: true) do |form| %>

      <% if @exercise_set.reps_per_series.present? %>
        <% @exercise_set.reps_per_series.each_with_index do |(series_number, details), index| %>
          <div>
            <div class="w-full bg-[#303030] rounded-[20px] p-2 mb-4 cursor-pointer flex justify-between items-center" data-action="click->dropdown#toggle">
              <div class="text-white text-sm font-semibold">Série <%= series_number %></div>
              <i class="fas fa-chevron-down text-white" data-dropdown-target="icon"></i> <!-- Ícone de seta -->
            </div>
            <div class="hidden transition-all duration-300 ease-in-out bg-[#202020] rounded-b-[20px] p-2 mb-4 overflow-hidden" data-dropdown-target="content">
              <div class="flex justify-between items-center text-white text-sm mb-2 space-x-2">
                <div>
                  <label for="serie_<%= series_number %>_reps" class="block text-xs mb-1">Repetições</label>
                  <%= number_field_tag "serie_#{series_number}_reps", details["reps"], class: "bg-[#202020] rounded-md p-2 text-gray-400 text-xs w-16 focus:outline-none focus:ring-2 focus:ring-[#ff8137]" %>
                </div>
                <div>
                  <label for="serie_<%= series_number %>_weight" class="block text-xs mb-1">Carga</label>
                  <%= number_field_tag "serie_#{series_number}_weight", details["weight"], class: "bg-[#202020] rounded-md p-2 text-gray-400 text-xs w-16 focus:outline-none focus:ring-2 focus:ring-[#ff8137]" %>
                </div>
                <div>
                  <label for="serie_<%= series_number %>_rest_time" class="block text-xs mb-1">Tempo de repouso</label>
                  <%= number_field_tag "serie_#{series_number}_rest_time", details["rest_time"], class: "bg-[#202020] rounded-md p-2 text-gray-400 text-xs w-16 focus:outline-none focus:ring-2 focus:ring-[#ff8137]" %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% else %>
        <p class="text-white">Nenhuma série encontrada.</p>
      <% end %>

      <div class="flex justify-center">
        <%= form.submit "Salvar", class: "bg-[#a52502] rounded-full px-3 py-1 text-white text-xs" %>
      </div>
    <% end %>
  </div>



  <!-- Bottom Navigation -->
  <div class="w-full max-w-[428px] bg-[#0e0e0e] rounded-t-[30px] p-3 mt-auto flex justify-around items-center">
    <div class="text-white text-sm"><i class="fa fa-home"></i></div>
    <div class="text-white text-sm"><i class="fa-solid fa-chart-column"></i></div>
    <%= link_to '/machines/select_equipment', class: 'bg-[#a52502] rounded-full p-3' do %>
      <i class="fa-solid fa-stop text-white text-lg"></i>
    <% end %>
    <div class="text-white text-sm"><i class="fa fa-calendar-alt"></i></div>
    <div class="text-white text-sm"><i class="fa fa-user"></i></div>
  </div>
</div>
